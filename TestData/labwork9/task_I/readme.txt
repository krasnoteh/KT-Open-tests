паттерн тестов тут довольно нетривиальный.
если вы придумаете его, можете сделать pull request